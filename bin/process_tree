#!/bin/bash

repo=$1
path=$2

if [[ -z "$path" ]]
then
    if [[ "$repo" =~ ([^/]+/+[^/]+)/*$ ]]
    then
        path=${BASH_REMATCH[1]}
        echo "Using path ${path}"
    else
        echo "Could not extract path from ${repo}"
        exit 1
    fi
fi

echo 'Pull repo'
if [[ -d repos/$path/repo ]]
then
    time (cd repos/$path/repo && git pull -f)
else
    time git clone $repo repos/$path/repo
fi

cd repos/$path/repo || exit
echo 'Create file list'
time find . -type d -exec sh -c 'printf "%s/\n" "$0"' {} \; -or -print | grep -v /.git/ | sort > ../files.txt
echo 'Create search index'
rm ../index.csearch
time CSEARCHINDEX=../index.csearch $HOME/go/bin/cindex .
# node bin/build_index.js ../files.txt > ../index.lunr.json
echo 'Get git log'
time git log --name-status > ../log.txt
echo 'Parse log to JSON'
time node ../../../../bin/parse_log.js < ../log.txt > ../log.json
